@*@model IEnumerable<AngularwithBootstrapProj.Models.Department>*@
@*@model AngularwithBootstrapProj.Models.Department;*@
@{
    ViewBag.Title = "Index";
}
<script src="~/js/angular.js"></script>

<h2>Index</h2>
<div ng-app="myApp">

    <div ng-controller="myCtrl" ng-init="GetAllData()" class="divList">
        <p>List of Employee</p>
        <div class="table-responsive-lg">
            <table cellpadding="12" class="table table-bordered table-condensed table-striped table-hover sortable">
                @*@if (@model.Count() == 0)
                    {
                        <tr>
                            <td colspan="10">No Record's found</td>
                        </tr>
                    }
                    else {*@
                <thead>
                    <tr class="alert-danger">
                        <th data-defaultsign="_19">
                            ID
                        </th>
                        <th data-defaultsign="AZ" data-firstsort="asc">
                            Name
                        </th>
                        <th data-defaultsign="AZ">
                            City
                        </th>
                        <th data-defaultsign="_19">
                            Age
                        </th>
                        <th data-defaultsign="AZ">
                            Dept
                        </th>
                        <th data-defaultsort="disabled">
                            Actions
                        </th>

                    </tr>
                </thead>
                <tr ng-repeat="EmpModel in employees">
                    <td>
                        {{EmpModel.EmpId}}
                    </td>
                    <td>
                        {{EmpModel.EmpName}}
                    </td>
                    <td>
                        {{EmpModel.EmpCity}}
                    </td>
                    <td>
                        {{EmpModel.EmpAge}}
                    </td>
                    <td>
                        {{EmpModel.DeptName}}
                    </td>
                    <td>
                        <input type="button" class="btn btn-warning" value="Update" ng-click="getEmployee(EmpModel)" />
                        <input type="button" class="btn btn-danger" value="Delete" ng-click="DeleteEmp(EmpModel)" />
                    </td>
                </tr>
                @*}*@
            </table>
        </div>
        <form name="empForm">
            <div class="form-horizontal" role="form">

                <div class="container">
                    <div class="row">
                        <h2><span id="spn">Add New Employee</span></h2>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-lg-4">
                            <div class="form-group">
                                <label class="col-md-4 control-label">Name:</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="inputEmail" placeholder="Name" name="Name" required ng-required="true" ng-minlength="3" ng-maxlength="100" ng-model="EmpModel.EmpName">
                                    <span class="error" ng-show="empForm.Name.$error.minlength">Required!</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4">
                            <div class="form-group">
                                <label class="col-md-4 control-label">City:</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="inputPassword" placeholder="City" name="City" required ng-required="true" ng-minlength="3" ng-maxlength="100" ng-model="EmpModel.EmpCity">
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4">
                            <div class="form-group">
                                <label class="col-md-4 control-label">Age:</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="inputLabel3" placeholder="Age" name="Age" value="0" required ng-required="true" ng-model="EmpModel.EmpAge">
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4">
                            <div class="form-group">
                                <label class="col-md-4 control-label">Department:</label>
                                <div class="col-md-12">
                                    <select ng-model="selectedDept" class="form-control" id="dept" ng-options="dt.DeptName for dt in departments track by dt.DeptCode">

                                        @*ng-change="getDepartments()" <option ng-modeloption data-ng-repeat="dt in Department" value="{{dt.DeptCode}}">{{dt.DeptName}}</option>*@
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4">
                            <div class="form-group">
                                <input type="button" id="btnSave" class="form-control btn-space" value="Submit" ng-click="empForm.$valid && InsertData()" style="background-color:cornflowerblue" />

                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4">
                            <div class="form-group">
                                <input type="button" id="btnCancel" class="form-control btn-space" value="Cancel" ng-click="CancelData()" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    @*Html.Hidden("EmpID_")*@
</div>

<script>
    
    var app = angular.module('myApp', []);

    app.controller('myCtrl', function ($scope, $http) {
        GetAllData();
        //Get All Employees
        function GetAllData() {
            $http.get('/Employee/Get_AllEmployee')
                .then(function (response) {
                $scope.employees = response.data;
                });

            $http.get('/Department/Get_AllDepartment')
                .then(function (response) {
                    $scope.departments= response.data;
                    if ($scope.departments.length > 0) {
                        $scope.selectedDept = $scope.departments[0];
                    }
                });
        };

        //Insert Employee
        $scope.InsertData = function (EmpModel) {

            var Action = document.getElementById("btnSave").getAttribute("value");
            $scope.EmpModel.DeptCode = $scope.selectedDept.DeptCode;
            if (Action == "Submit") {
                var url = '/Employee/InsertEmployee'
                    , data = JSON.stringify($scope.EmpModel)
                    , config = 'application/json';

                $http.post(url, data, config)
                //$http({
                //    method: 'POST',
                //    url: '/Employee/InsertEmployee',
                //    contentType: 'application/json',
                //    data: JSON.stringify($scope.EmpModel)
                //    //data: $scope.EmpModel.data

                //})
                    .then(function () {
                    GetAllData();
                    $scope.EmpModel = null;
                    alert("Added Successful");
                });
                
            } else {

                $http({
                    method: 'PUT',
                    url: '/Employee/UpdateEmployee/',
                    data: $scope.EmpModel.data
                }).then(function () {
                    GetAllData();
                    $scope.EmpModel = null;
                    document.getElementById("btnSave").setAttribute("value", "Submit");
                    document.getElementById("btnSave").style.backgroundColor = "cornflowerblue";
                    document.getElementById("spn").innerHTML = "Add New Employee";
                    alert("Updated Successful");
                });
                //    .error(function () {
                //    alert(data.errors);
                //});

            }
            GetAllData();
        };

        //Delete Employee
        $scope.DeleteEmp = function (EmpModel) {

            varIsConf = confirm('Want to delete ' + EmpModel.EmpId + '. Are you sure?');
            if (varIsConf) {
                $http.delete('/Employee/DeleteEmployee/' + EmpModel.EmpId)
                    .then(function () {
                        $scope.errors = [];
                        GetAllData();
                        alert(EmpModel.EmpName + " Deleted Successfully!!");
                    });
                    //.error(function () {
                    //    alert(data.errors);
                    //});
            }
        };

        //Get Employee by id to edit
        $scope.getEmployee = function (EmpModel) {
            $http.get('/Employee/getById/' + EmpModel.EmpId)
                .then(function (response, status, headers, config) {
                    //GetAllData();

                    $scope.EmpModel = response.data;
                    $scope.EmpModel.DeptCode = response.data.DeptCode;
                    $scope.selectedDept.DeptCode = response.data.DeptCode;

                    document.getElementById("btnSave").setAttribute("value", "Update");
                    document.getElementById("btnSave").style.backgroundColor = "Yellow";
                    document.getElementById("spn").innerHTML = "Update Employee Information";
                });
                //.error(function () {
                //    alert(data.errors);
                //});
        };
    })
</script>